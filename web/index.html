<!DOCTYPE html>
<html>
  <head>
    <title>Infoboard</title>
    <meta http-equiv="refresh" content="600">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/umbrellajs"></script>
    <script type="text/javascript" src="http://builds.handlebarsjs.com.s3.amazonaws.com/handlebars-v4.0.12.js"></script>

    <script id="templates/forecast" type="text/x-handlebars-template">
      <ul class="forecast">
      {{#each forecasts}}
      <li class="forecast-entry">
        <span class="time">{{time}}</span>
        <img class="icon" src="{{iconUrl}}" alt="icon" />
        <div class="clearer"></div>
        <span>{{temp}}</span>, <span>Wind: {{wind}}<span><br>
        <span>{{rain}}</span>
      </li>
      {{/each}}
      </ul>
    </script>
    <script id="templates/tube-status" type="text/x-handlebars-template">
      <div id="tube-disruptions">
      {{#each alerts}}
        <div class="coloumn {{lineId}}">
          <p>
            <span>{{line}}</span><br />
            <span>{{summary}}</span>
          </p>
        </div>
      {{else}}
        <div class="coloumn">
          <p>All good</p>
        </div>
      {{/each}}
      </div>
    </script>

    <script type="text/javascript">
      var TubeAlerts = function(response) {
        var _getAlerts = function() {
          var affectedLines = response.filter(function(line) {
            return line.lineStatuses[0].statusSeverityDescription != "Good Service";
          });
          console.log(response);
          console.log(affectedLines);

          var alerts = affectedLines.map(function(line) {
            return {
              line: line.name,
              lineId: line.id,
              summary: line.lineStatuses[0].statusSeverityDescription
            };
          });

          return alerts;
        };

        return {
          alerts: _getAlerts()
        }
      }

      var Forecast = function(response) {
        var
          _getIconUrl = function(icon) {
            return "http://openweathermap.org/img/w/" + icon + ".png";
          },
          _getRainSummary = function(rain) {
            if (rain === undefined) { return "No rain"; }

            var rainmm = rain["3h"];
            var summary;
            if (rainmm < 0.1) {
              summary = "No rain";
            } else if (rainmm < 0.5) {
              summary = "Light rain";
            } else {
              summary = "Heavy rain"
            };
            return summary + " (" + (Math.round(rainmm * 100) / 100).toString() + "mm)";
          },
          _getWindSummary = function(wind) {
            if (wind === undefined) { return "No" }

            var kph = wind.speed * 3.6;
            return (Math.round(kph * 100) / 100).toString() + "kph";
          },
          _forecasts = response.list.slice(0, 4).map(function(forecast) {
            return {
              time: forecast.dt_txt.split(" ")[1].split(":").slice(0, 2).join(":"),
              temp: Math.round(forecast.main.temp) + "C",
              iconUrl: _getIconUrl(forecast.weather[0].icon),
              rain: _getRainSummary(forecast.rain),
              wind: _getWindSummary(forecast.wind),
            };
          });

        return {
          forecasts: _forecasts
        }
      };

      var updateWeather = function() {
        fetch("http://lvh.me:9000/forecast")
        .then(function(response) {
          return response.json();
        })
        .then(function(json) {
          displayWeather(json);
        })
        .catch(function(err) {
          console.log("faszom");
          console.log(err);
        });
      };

      var updateTubeStatus = function() {
        fetch("https://api.tfl.gov.uk/line/mode/tube/status")
        fetch("https://gist.githubusercontent.com/cromega/f72412ec9a88e649a4973c5100911698/raw/83bf940cb3521e40c7589f884ef64024a758c460/tube.json")
        .then(function(response) {
          return response.json();
        })
        .then(function(json) {
          displayTubeStatus(json);
        })
        .catch(function(err) {
          console.log("faszom");
          console.log(err);
        });
      };

      setInterval(function() {
        //updateWeather;
        updateTubeStatus;
      }, 600000);

      var displayWeather = function(weatherData) {
        var source = document.getElementById("templates/forecast").innerHTML;
        var template = Handlebars.compile(source);

        var forecast = new Forecast(weatherData);
        u("#weather-info").html(template(forecast));
      };

      var displayTubeStatus = function(tubeStatusData) {
        var source = document.getElementById("templates/tube-status").innerHTML;
        var template = Handlebars.compile(source);

        var tubeStatus = new TubeAlerts(tubeStatusData);
        console.log(tubeStatus);
        u("#tube-status").html(template(tubeStatus));
      };

      //updateWeather();
      updateTubeStatus();
    </script>

    <style type="text/css">
      html {
        width: 480px;
        height: 320px;
      }

      body {
        box-sizing: border-box;
        width: 100%;
        height: 100%;
        border: 1px solid darkgray;
        overflow: hidden;
        background-color: gray;
      }
      .panel {
        height: 100%;
        width: 100%;
        display: block;
        overflow: hidden;
      }

      ul.forecast {
        padding: 0px;
        margin: 0px;
      }

      li.forecast-entry {
        float: left;
        width: 239px;
        height: 159px;
        list-style: none;
        color: white;
        font-size: 130%;
      }
      .time {
        float: left;
        line-height: 70px;
      }
      .icon {
        width: 100px;
        height: 100px;
      }

      #tube-disruptions {
        width: 100%;
        display: table;
      }

      #tube-disruptions > .coloumn {
        max-width: 140px;
        display: table;
        float: left;
        height: 320px;
      }

      #tube-disruptions p {
        color: white;
        mix-blend-mode: exclusion;
        text-shadow: 3px 3px 0px #000;
        vertical-align: middle;
        text-align: center;
        display: table-cell;
        font-size: 140%;
        padding: 10px;
      }

      #tube-disruptions .bakerloo { background-color: #B36305; }
      #tube-disruptions .central { background-color: #E32017; }
      #tube-disruptions .circle { background-color: #FFD300; }
      #tube-disruptions .district { background-color: #00782A; }
      #tube-disruptions .hammersmith { background-color: #F3A9BB; }
      #tube-disruptions .jubilee { background-color: #A0A5A9; }
      #tube-disruptions .metropolitan { background-color: #9B0056; }
      #tube-disruptions .northern { background-color: #000000; }
      #tube-disruptions .piccadilly { background-color: #003688; }
      #tube-disruptions .victoria { background-color: #0098D4; }
      #tube-disruptions .waterloo { background-color: #95CDBA; }
      #tube-disruptions .dlr { background-color: #00A4A7; }
      #tube-disruptions .overground { background-color: #EE7C0E; }
      .clearer { clear: both; }
    </style>
  </head>

  <body>
    <div class="panel">
      <div id="weather-info" class="panel-content"></div>
      <div id="tube-status" class="panel-content"></div>
    </div>
  </body>
</html>
