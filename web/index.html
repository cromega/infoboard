<!DOCTYPE html>
<html>
  <head>
    <title>Infoboard</title>
    <meta http-equiv="refresh" content="600">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/umbrellajs"></script>
    <script type="text/javascript" src="http://builds.handlebarsjs.com.s3.amazonaws.com/handlebars-v4.0.12.js"></script>
    <script id="templates/forecast" type="text/x-handlebars-template">
      <ul class="forecast">
      {{#each forecasts}}
      <li class="forecast-entry">
        <span class="time">{{time}}</time>
        <img class="icon" src="{{iconUrl}}" alt="icon" />
        <div class="clearer"></div>
        <span>{{temp}}</span><br>
        <span>Rain? {{rain}}
      </li>
      {{/each}}
      </ul>
    </script>
    <script type="text/javascript">
      var Forecast = function(response) {
        var
          _getIconUrl = function(icon) {
            return "http://openweathermap.org/img/w/" + icon + ".png";
          },
          _getRainSummary = function(rain) {
            if (rain === undefined) { return "No"; }

            var rainmm = rain["3h"];
            var summary;
            if (rainmm < 0.1) {
              summary = "No";
            } else if (rainmm < 0.5) {
              summary = "Light";
            } else {
              summary = "Lots. Probably"
            };
            return summary + " (" + rainmm.toString() + "mm)";
          },
          _forecasts = response.list.slice(0, 4).map(function(forecast) {
            return {
              time: forecast.dt_txt.split(" ")[1].split(":").slice(0, 2).join(":"),
              temp: Math.round(forecast.main.temp) + "C",
              iconUrl: _getIconUrl(forecast.weather[0].icon),
              rain: _getRainSummary(forecast.rain),
            };
          });

        return {
          forecasts: _forecasts
        }
      };

      var updateWeather = function() {
        fetch("http://lvh.me:9000/forecast")
        .then(function(response) {
          return response.json();
        })
        .then(function(json) {
          displayWeather(json);
        })
        .catch(function(err) {
          console.log("faszom");
          console.log(err);
        });
      };

      setInterval(function() {
        updateWeather;
      }, 600000);

      var displayWeather = function(weatherData) {
        var source = document.getElementById("templates/forecast").innerHTML;
        var template = Handlebars.compile(source);

        var forecast = new Forecast(weatherData);
        u("#weather-info").html(template(forecast));

      };

      updateWeather();
    </script>

    <style type="text/css">
      html {
        width: 480px;
        height: 320px;
      }

      body {
        box-sizing: border-box;
        width: 100%;
        height: 100%;
        border: 1px solid darkgray;
        overflow: hidden;
        background-color: gray;
      }
      .panel {
        height: 100%;
        width: 100%;
        display: block;
        overflow: hidden;
      }

      ul.forecast {
        padding: 0px;
        margin: 0px;
      }

      li.forecast-entry {
        float: left;
        width: 239px;
        height: 159px;
        list-style: none;
        color: white;
        font-size: 140%;
      }
      .icon {
        width: 100px;
        height: 100px;
      }
      .clearer { clear: both; }
    </style>
  </head>

  <body>
    <div class="panel">
      <div id="weather-info" class="panel-content">
      </div>
    </div>
  </body>
</html>
